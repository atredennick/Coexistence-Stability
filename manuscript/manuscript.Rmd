---
layout: 12pt
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
   - \doublespacing
bibliography: ~/Dropbox/Bibliography/CoexistStability.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: false
fontsize: 12pt
geometry: margin=1in
linkcolor: black
urlcolor: black

---

\begin{centering}

\textbf{\large{How Fluctuation-Dependent Coexistence Mechanisms Affect the Temporal Stability of Ecosystem Function}}



\vspace{2.5em}

\renewcommand*{\thefootnote}{\fnsymbol{footnote}}

Andrew T. Tredennick\textsuperscript{1,}\footnote{Corresponding author; email: atredenn@gmail.com}, Peter B. Adler\textsuperscript{1}, and Frederick R. Adler\textsuperscript{2}

\vspace{1.5em}

\textit{\small{\textsuperscript{1}Department of Wildland Resources and the Ecology Center, Utah State University, Logan, Utah 84322}}; \textit{\small{\textsuperscript{2}Departments of Biology and Mathematics, University of Utah, Salt Lake City, Utah}} 

\end{centering}

```{r caching, include=FALSE}
library("methods")
library("knitr")
basename <- "manuscript"
opts_chunk$set(fig.path = paste("components/figure/", basename, "-", sep=""),
               cache.path = paste("components/cache/", basename, "/", sep=""))
opts_chunk$set(cache = 2)
opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE, 
               comment = NA, verbose = TRUE, echo=FALSE)

# PDF-based figures
opts_chunk$set(dev='pdf')
```


```{r plot-options, message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
               "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

opts_chunk$set(dev='pdf', dev.args=c(version="1.3"))

```

\begin{abstract}

For biodiversity to increase the temporal stability of ecosystem function in the long-term, coexistence must be stable.
Species-specific respones to environmental variation through time is key to understanding fluctuation-dependent coexistence mechanisms and how asynchrony in species dynamics can arise to stabilize ecosystem function.
Despite the shared dependence on environmental fluctuations, theory on species coexistence and the relationship between species richness and ecosystem stability have developed independently.
To formally link the two bodies of theory, we use consumer-resource models where coexistence between two species utilizing a single resource is maintained by two fluctuation-dependent mechanisms: the storage effect and relative nonlinearity.
We examine how the strength of species coexistence relates to the temporal stability of aggregate ecosystem function and how the effect of environmental variability on stability is mediated by the mechanism of coexistence.
Blah, blah, blah...

\vspace{2em}

\noindent \textit{Keywords}: coexistence, storage effect, relative nonlinearity, diversity-stability hypothesis, pulsed differential equation, consumer-resource dynamics, synchrony

\end{abstract}

\setlength{\parindent}{5ex}

Introduction
------------
Species-specific responses to non-constant environmental conditions can stabilize species coexistence [@Chesson2000] and ecosystem function [@Loreau2010].
This means that fluctuation-dependent mechanisms of species coexistence are the very same mechanisms that link biodiversity and ecosystem function.
Yet, the theory that has developed over the past 20 years to explain the, generally, positive relationship between species richness and stability of ecosystem function has implicitly assumed species coexistence [@Loreau2010], or, when explicitly considered, coexistence is maintained by fluctuation-independent mechanisms [@Turnbull2013].
Despite rapid theoretical developments in the fields of species coexistence and biodiversity-ecosystem function, a gulf remains between the two lines of inquiry [@Carroll2011; @Turnbull2013].
This is especially surprising since stable coexistece, however maintained, is a preqrequisite for biodiversity to confer stability of ecosystem function in the long term.

Among the dizzying array of mechanisms that can maintain diversity, @Chesson2000 formalized two broad classes: fluctuation-independent and fluctuation-dependent mechanisms.
Both classes of mechanisms rely on niche differences being greater than relative fitness differences for all species pairs in a community [@Chesson2000; @Adler2007a].
In a fluctuation-independent case, species coexistence can be maintained by resource partitioning so long as each species is limited by a different resource [@Tilman1982].
Much of the theoretical literature aimed at deciphering the mechanisms behind the diversity-stability relationship implicitly assumes fluctuation-independent coexistence.
For example, Lotka-Volterra models have been widely used and include coexistence by keeping competition coefficients less than one [e.g., @Loreau2013].
Our focus, on the other hand, is on the interaction between species coexistence and ecosystem stability in communities where coexistence is dependent on environmental fluctuations.

There are two ways that species coexist in temporally fluctuating environments.
First, there is the storage effect, where species coexistence is stable if the following three conditions are met: (i) have unique responses to environmental conditions, (ii) have some way to persist in unfavorable years, and (iii) the effects of competition must be greater in 'good' years relative to 'bad' years [@Chesson2000].
Second, there is relative nonlinearity, where species have unique, nonlinear responses to a shared resource that fluctuates through time [@Chesson2000].

Both the storage effect and relative nonlinearity require that species have unique responses to environmental conditions.
Not only do such species-specific responses stabilize coexistence, they can also stabilize ecosystem function by creating compensatory dynamics.
All else being equal, ecosystem stability is highest when species responses to the environment are perfectly uncorrelated.
Under the storage effect, uncorrelated species responses to the environment also results in the most stable conditions for coexistence.
It stands to reason, then, that the strength of the storage effect should predict the degree to which species asynchrony stabilizes ecosystem function.
However, the exact relationship between storage effect strength and ecosystem stability could take many, unknown, forms.

Unlike the potential interaction between the storage effect and ecosystem stability, how relative nonlinearity might interact with ecosystem stability is less clear.


Model and Analysis
------------------------------
### A General Consumer-Resource Model

We start with a general consumer-resource model where the consumer can be in one of two-states: a dormant state $D$ and a live state $N$ (Fig. 1). Transitions between $N$ and $D$ occur at discrete intervals $T$, so our model is formulated as ``pulsed differential equations" [@Pachepsky2008; @Mailleret2009]. For clarity we refer to $T$ as years and the growing time between years as seasons with daily ($\tau$) time steps. Seasonal (within-year) dynamics are modeled as three differential equations:

\begin{align}
\frac{\text{d}D_{i}}{\text{d}\tau} &= N_{i}a_{i} - (m_{D,i}D_{i})\\
\frac{\text{d}N_{i}}{\text{d}\tau} &= N_{i}[f_{i}(R) - m_{N,i} - a_{i}]\\
\frac{\text{d}R}{\text{d}\tau} &= r_{\tau} - \sum\limits_{i=1,2}f_{i}(R)N_{i}
\end{align}

\noindent where $i$ denotes species, $D$ is the dormant (long-lived) biomass state, $N$ is the living biomass (fast-growing, shorter-lived) state, *a* is fraction of life biomass allocated to seed production, and *m* is the biomass loss rate. The growth rate of living biomass is a resource-dependent Hill function, $f_{i}(R) = b_{i}R^{\alpha_{i}} / (\beta_{i}^{\alpha_{i}}+R^{\alpha_{i}})$, where *b* is a species' intrinsic growth rate and $\alpha$ and $\beta$ define the curvature of the function. The single resource *R* is replenished with daily pulse, $r_{\tau}$, randomly drawn from a log normal distribution: $r_{\tau} = \text{LogNormal}(R_\mu, R_\sigma)$. Resource depletion is equal to the sum of each species' consumption, $\sum_{i=1,2}f_{i}(R)N_{i}$. 

At the beginning of each season we start with initial conditions defined as $V_{t}$, $W_{t}$, and $Z_{t}$ for the dormant state, the live state, and the resource, respectively. So for each season, eqs. 1-3 are solved given the initial conditions:
\begin{align}
  D_{i}(0) &= V_{i,t} \\
  N_{i}(0) &= W_{i,t} \\
  R(0) &= Z_{t}
\end{align}
\noindent The consumers transition between $N$ and $D$ instantaneously between years. So, at the yearly transition:
\begin{align}
  V_{i,t+1} &= [N_{i}(T^-)+D_{i}(T^-)](1-g_{t}) \\
  W_{i,t+1} &= [N_{i}(T^-)+D_{i}(T^-)]g_{t} \\
  Z_{t+1} &= R(T^-) + R(T^+)
\end{align}
\noindent where $D(T^-)$, $N(T^-)$, and $R(T^-)$ are the densities of each state at the end of the year and $g$ is a time-fluctuating activation rate that regulates how much dormant biomass is converted to growing-season live biomass each year. $R(T^+)$ is a randomly generated resource pulse from a log-normal distribution with mean $R_\mu$ and variance $R_{\sigma^2}$ (same mean and variance used to generate daily pulses). Our formulation assumes that at the end of each season all accumulated living biomass [$N(T^-)$] is converted to dormant biomass. Parameter notations and definitions are in table 1.

\begin{center}
\begin{table}
\caption{Definition of model states and parameters. `Constant' parameters do not fluctuate during a simulation, while `variable' parameters do fluctuate through time in a given simulation.}
\begin{tabular}{l l}
\hline
Parameter & Definition \\
\hline
$N$ & live biomass \\
$D$ & dormant biomass \\
$R$ & resource supply \\
$m_{D}$ & dormant state mortality rate (constant) \\
$b$ & live state maximum resource uptake rate (constant) \\
$m_{N}$ & live state mortality rate (constant) \\
$a$ & allocation fraction of live biomass to seed bank (constant) \\
$g$ & dormant-to-live biomass transition fraction (variable) \\ 
$\rho$ & correlation of species' responses transition cue (constant) \\
$\sigma^2_{E}$ & variance of transition cue (constant) \\
$r$ & daily resource supply pulse (variable) \\
$R_{\mu}$ & mean resource pulse, on log scale (constant) \\
$R_{\sigma^2}$ & variance of daily resource supply, on log scale (constant) \\

\hline
\end{tabular}
\end{table}
\end{center}

### Implementing the Storage Effect
To make this a ``storage-effect" model, we need to satisfy three conditions: (1) the organisms must have a mechanism for persistence under unfavorable conditions, (2) species must respond differently to environmental conditions, and (3) the effects of competition on a species must be more strongly negative in good years relative to unfavorable years. Our model meets condition 1 because we include a dormant stage with very low death rates. We satisfy condition 2 with our model whenever $g$ is not perfectly correlated between species. Lastly, our model meets condition 3 because condition 2 partitions intraspecific and interspecific competition into different years. Thus, during a high $g$ year for one species, resource uptake is also inherently high for that species, which increases intraspecific competition relative to interspecific competition. So, given adequate variability in $g$, the inferior competitor (species with lower $r$) can persist. 

Following @Adler2008, we generated sequences of (un)correlated dormant-to-live state transition rates ($g$) for each species by drawing from multivariate normal distributions with mean 0 and a variance-covariance matrix ($\Sigma_g$) of

\begin{align}
\Sigma_g = 
\begin{bmatrix}
\sigma^2_{E} & \rho\sigma^2_{E} \\
\rho\sigma^2_{E} & \sigma^2_{E}
\end{bmatrix}
\end{align}

\noindent where $\sigma^2_{E}$ is the variance and $\rho$ is the correlation between between the two species' transition rates. For environmental variability, here induced as variability in $g$, to promote coexistence via the storage effect, $\rho$ must be less than 1. The inferior competitor has the strongest potential to persist when $\rho=-1$ (perfectly uncorrelated transition rates). 

### Implementing Relative Nonlinearity
When considering consumer-resource dynamics, species coexistence by relative nonlinearity requires that each species has different nonlinear responses to resource availability, and resource availability must fluctuate through time. In a constant resource environment, the species with the lowest R* will always exclude the other species. So we can compare this model to the storage effect model, we still allow the germination rate \emph{g} to vary, but both species are perfectly correlate -- that is, $\rho=1$. 

```{r model_types, cache=FALSE, warning=FALSE, message=FALSE, eval=TRUE, fig.height=4.5, fig.width=8, fig.cap="Resource uptake functions and example time series of (un)correlated germination fractions for the storage effect (*a,b*) and relative nonlinearity (*c,d*) formulations of the consumer-resource model. The resource uptake functions for both species are equivalent for the storage effect, but their germination fractions are uncorrelated in time. The opposite is true for relative nonlinearity: the two species have unique resource uptake functions, but their germination fractions are perfectly correlated in time."}
library(ggplot2)
library(ggthemes)
library(mvtnorm)
library(gridExtra)
 ##  Resource uptake function (Hill function)
  uptake_R <- function(r, R, alpha, beta){
    return((r*R^alpha) / (beta^alpha + R^alpha))
  }
  # Get "germination" fractions for each year
  getG <- function(sigE, rho, nTime){
    varcov <- matrix(c(sigE, rho*sigE, rho*sigE, sigE), 2, 2)
    e <- rmvnorm(n = nTime, mean = c(0,0), sigma = varcov)
    g <- exp(e) / (1+exp(e))
    return(g)
  }

## STORAGE EFFECT PLOTS
parms <- list(
  r = c(5,5),         # max growth rate for each species
  alpha = c(5,5),     # rate parameter for Hill function 
  beta = c(20,20),    # shape parameter for Hill function
  mN = c(0.5,0.5),    # live biomass loss (mortality) rates 
  mD = c(0.01, 0.01), # dormant biomass loss (mortality) rates
  a = c(0.5,0.5)      # allocation fraction of live biomass to seed bank
)
R <- seq(0,100,1)
out_r <- matrix(ncol=2, nrow=length(R))
alpha <- parms$alpha
beta <- parms$beta
for(i in 1:nrow(out_r)){
  out_r[i,1] <- uptake_R(parms$r[1], R[i], alpha[1], beta[1])
  out_r[i,2] <- uptake_R(parms$r[2], R[i], alpha[2], beta[2])
}
strg_uptake <- data.frame(species=rep(c(1:2), each=nrow(out_r)),
                          resource=rep(R, times=2),
                          uptake=c(out_r[,1], out_r[,2]))
strg_uptake_plot <- ggplot()+
  geom_line(data=strg_uptake, aes(x=resource, y=uptake, color=as.factor(species), size=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=c("#9D6188","#97A861"), name="Species")+
  scale_size_manual(values=c(3,1))+
  guides(size=FALSE, linetype=FALSE)+
  xlab("Resource")+
  ylab("Resource Uptake Rate")+
  theme(legend.position=c(0.7,0.35))+
  geom_text(aes(x=1,y=5,label="a"))

sigE <- 2   # environmental cue variability
rho <- 0    # environmental cue correlation between species
gVec <- getG(sigE = sigE, rho = rho, nTime = 50)
germ_rate <- data.frame(species=rep(c(1:2),each=50),
                        timestep=rep(c(1:50), times=2),
                        germrate=c(gVec[,1], gVec[,2]))
strg_germ_plot <- ggplot()+
  geom_line(data=germ_rate,size=1,aes(x=timestep, y=germrate, color=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=c("#9D6188","#97A861"), name="Species")+
  guides(size=FALSE, linetype=FALSE, color=FALSE)+
  xlab("Simulation Year")+
  ylab("Germination Fraction")+
  geom_text(aes(x=1,y=1,label="b"))


## RELATIVE NONLINEARITY PLOTS
parms <- list(
  r = c(5,1),          # max growth rate for each species
  alpha = c(5,2),      # rate parameter for Hill function 
  beta = c(20,2.5),    # shape parameter for Hill function
  mN = c(0.5,0.5),     # live biomass loss (mortality) rates 
  mD = c(0.01, 0.01),  # dormant biomass loss (mortality) rates
  a = c(0.5,0.5)       # allocation fraction of live biomass to seed bank
)
R <- seq(0,100,1)
out_r <- matrix(ncol=2, nrow=length(R))
alpha <- parms$alpha
beta <- parms$beta
for(i in 1:nrow(out_r)){
  out_r[i,1] <- uptake_R(parms$r[1], R[i], alpha[1], beta[1])
  out_r[i,2] <- uptake_R(parms$r[2], R[i], alpha[2], beta[2])
}
reln_uptake <- data.frame(species=rep(c(1:2), each=nrow(out_r)),
                          resource=rep(R, times=2),
                          uptake=c(out_r[,1], out_r[,2]))
reln_uptake_plot <- ggplot()+
  geom_line(data=reln_uptake, aes(x=resource, y=uptake, color=as.factor(species), size=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=c("#9D6188","#97A861"), name="Species")+
  scale_size_manual(values=c(1,1))+
  guides(size=FALSE, linetype=FALSE, color=FALSE)+
  xlab("Resource")+
  ylab("Resource Uptake Rate")+
  geom_text(aes(x=1,y=5,label="c"))

sigE <- 2   # environmental cue variability
rho <- 1    # environmental cue correlation between species
gVec <- getG(sigE = sigE, rho = rho, nTime = 50)
germ_rate <- data.frame(species=rep(c(1:2),each=50),
                        timestep=rep(c(1:50), times=2),
                        germrate=c(gVec[,1], gVec[,2]))
reln_germ_plot <- ggplot()+
  geom_line(data=germ_rate,size=1,aes(x=timestep, y=germrate, color=as.factor(species), linetype=as.factor(species), size=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=c("#9D6188","#97A861"), name="Species")+
  scale_size_manual(values=c(4,1))+
  guides(size=FALSE, linetype=FALSE, color=FALSE)+
  xlab("Simulation Year")+
  ylab("Germination Fraction")+
  geom_text(aes(x=1,y=1,label="d"))

g_strg <- grid.arrange(strg_uptake_plot, strg_germ_plot, 
                       reln_uptake_plot, reln_germ_plot,
                       ncol=2, nrow=2)
```

### Model Simulations
For each coexistence mechanism (storage effect, relative nonlinearity), we ran model simulations at different levels of resource variance ($R_{\sigma^2}$), environmental cue variance ($\sigma_E$), and correlation of species responses to the environmental cue ($\rho$). 
We ran simulations for 2,000 'years' with 60 day growing seasons. 
We averaged biomass over the growing season.
After discarding an initial 100 years to reduce transient effects on our results, we calculated the stability of summed species biomass through time and species synchrony through time.
For storage effect simulations, species were equivalent in their ability to capture and assimilate the resource (*R*) but had different, depending on $\rho$, germination rates.
For relative nonlinearity simulations, species had equivalent germination rates ($\rho = 1$) but different resource acquisition functions (fig. 1).
We explored a limited set of parameter space where the storage effect and relative nonlinearity were operating simultaneously.
Within-season dynamics were solved given initial conditions using the package 'deSolve' [@Soetaert2010] in R [@Team2013].

Results
-------
The stability of coexistence ($1-\rho$) and the coefficient of variation of total biomass were negatively correlated (rank correlation = -0.19) when species coexistence was maintained by the storage effect.
Species asynchrony decreased as correlations among species' responses to the environmental cue increased (fig. 2a) and the coefficient of variation of total biomass increased (fig. 2b).
These relationships were unaffected by the variance of the resource, but asynchrony and the coefficient of variation of total biomass were always higher at higher levels of resource variability (fig. 2a-b).

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/storage_effect_synchstability.png}
  \caption{Results from storage effect simulations showing the relationships between the correlation of species' responses to the environmental cue for germination and simulated species asynchrony (\textit{a}), coefficient of variation of total community biomass (\textit{b}), mean total community biomass (\textit{c}), and standard deviation of total community biomass (\textit{d}). Color ramps indicate the value of resource variability ($\sigma_R$) for a given simulation.}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/relative_nonlinearity_synchstability.png}
  \caption{Results from relative nonlinearity simulations showing the relationships between tresource variability ($\sigma_R$) and simulated species asynchrony (\textit{a}), coefficient of variation of total community biomass (\textit{b}), mean total community biomass (\textit{c}), and standard deviation of total community biomass (\textit{d}). The correlation of species' responses to the environmental cue for germination was equal to one for all relative nonlinearity simulations ($\rho=1$).}
\end{figure}

Discussion
----------


\pagebreak{}

\setlength{\parindent}{0ex}

References
----------
