---
layout: 12pt
header-includes:
  - \usepackage{lineno}
  - \linenumbers
  - \usepackage{setspace}
  - \usepackage{todonotes}
  - \doublespacing
  - \usepackage{rotating}
  - \usepackage{color, soul}
  - \usepackage[font={footnotesize},labelfont=bf]{caption}
  - \usepackage{times} 
  - \usepackage{sectsty}
bibliography: ~/Dropbox/Bibliography/CoexistStability.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: false
fontsize: 12pt
geometry: margin=1in
linkcolor: black
urlcolor: black
---

\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\allsectionsfont{\normalfont\sffamily\bfseries}

\begin{singlespace}

\begin{centering}

\textsf{\large{\textbf{How fluctuation-dependent species coexistence affects the diversity-stability relationship}}}



\vspace{2.5em}

\renewcommand*{\thefootnote}{\fnsymbol{footnote}}

Andrew T. Tredennick\textsuperscript{1}, Peter B. Adler\textsuperscript{1}, and Frederick R. Adler\textsuperscript{2}

\vspace{1.5em}

\textit{\small{\textsuperscript{1}Department of Wildland Resources and the Ecology Center, Utah State University, Logan, Utah 84322}} \\
\textit{\small{\textsuperscript{2}Departments of Biology and Mathematics, University of Utah, Salt Lake City, Utah}} 

\end{centering}

\vspace{3em}

\noindent \textbf{Keywords}: coexistence, storage effect, relative nonlinearity, diversity-stability hypothesis, pulsed differential equation, consumer-resource dynamics

\noindent \textbf{Authorship}: All authors conceived the research and designed the modeling approach; ATT conducted model simulations, with input from PBA and FRA; ATT wrote the manuscript and all authors contributed to revisions.

\noindent \textbf{Running Title}: Environmental variability, ecosystem stability, \& species coexistence

\noindent \textbf{Article Type}: Letter

\noindent \textbf{Number of Words}:

\noindent \textbf{Number of References}:

\noindent \textbf{Number of Tables and Figures}:

\noindent \textbf{Corresponding Author}:  \\
Andrew Tredennick  \\
Department of Wildland Resources and the Ecology Center  \\
Utah State University  \\
5230 Old Main Hill  \\
Logan, Utah 84322 USA  \\
Phone: +1-970-443-1599  \\
Fax: +1-435-797-3796  \\
Email: atredenn@gmail.com

\end{singlespace}

```{r caching, include=FALSE}
library("methods")
library("knitr")
basename <- "manuscript"
opts_chunk$set(fig.path = paste("components/figure/", basename, "-", sep=""),
               cache.path = paste("components/cache/", basename, "/", sep=""))
opts_chunk$set(cache = 2)
opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE, 
               comment = NA, verbose = TRUE, echo=FALSE)

# PDF-based figures
opts_chunk$set(dev='pdf')
```


```{r plot-options, message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
               "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

opts_chunk$set(dev='pdf', dev.args=c(version="1.3"))

```

\newpage{}

\begin{abstract}
For biodiversity to increase the temporal stability of ecosystem function in the long-term, coexistence must be stable.
Species-specific respones to environmental variation through time is key to understanding fluctuation-dependent coexistence mechanisms and how asynchrony in species dynamics can arise to stabilize ecosystem function.
Despite the shared dependence on environmental fluctuations, theory on species coexistence and the relationship between species richness and ecosystem stability have developed independently.
To formally link the two bodies of theory, we use consumer-resource models where coexistence between two species utilizing a single resource is maintained by two fluctuation-dependent mechanisms: the storage effect and relative nonlinearity.
We examine how the strength of species coexistence relates to the temporal stability of aggregate ecosystem function and how the effect of environmental variability on stability is mediated by the mechanism of coexistence.
Blah, blah, blah...
\vspace{2em}
\end{abstract}


\newpage{}

\setlength{\parindent}{5ex}

INTRODUCTION
------------
@MacArthur1955, @Elton1958, and even Darwin [@Turnbull2013] recognized that species can compensate for each other and stabilize functioning in ecosystems subject to temporal variation in environmental conditions. 
This idea underlies the "insurance hypothesis" [@Yachi1999], which suggests stability increases with diversity because species respond dissimilarly to environmental conditions â€“ species A has highest growth rates under conditions X whereas species B has highest growth rates under conditions Y. 
More species confer temporal stability by broadening the range of conditions under which the community maintains function [@Loreau2010].
Diverse models all predict a positive relationship between species richness and ecosystem stability [@Lehman2000; @Ives2002b; @Loreau2013], and experimental tests tend to support such a prediction [@Tilman2006; @Hector2010].
However, empirical support for a positive diversity-stability relationship is not unequivocal [@Jiang2009], and theory on the relationship between biodiversity and ecosystem stability often ignores the processes that determine species coexistence in variable environments [@Loreau2010].

For the benefits of biodiversity to be realized in the long term, species coexistence, which maintains biodiversity, must be stable [@Turnbull2013].
Contemporary coexistence theory can be divided into two broad classes: fluctuation-dependent mechanisms and fluctuation-independent mechanisms [@Chesson2000].
Classic work on resource partitioning [@Tilman1982] describes fluctuation-independent species coexistence, where stable coexistence depends on limiting resource requirements, not fluctuations in population abundances or environmental conditions.
In contrast, fluctuation-dependent coexistence mechanisms require the environment to fluctuate over time for species to coexist.
Indeed, the two most well-known fluctuation-dependent coexistence mechanisms, the storage effect and relative nonlinearity, depend on species-specific responses to environmental conditions, among other things, for species to stably coexist [@Chesson2004].
Thus, two forces can strengthen species coexistence: the uniqueness of their environmental responses and the variability of environmental conditions.
In other words, there is reason to expect environmental variability to promote species richness when coexistence is maintained by a fluctuation-dependent mechanism [@Adler2008].
Of course, increasing environmental variability may also decrease ecosystem stability through time by increasing the fluctuations of individual species, regardless of species richness.

The countervailing effects of environmental variability present an interesting paradox: increasing variability should decrease ecosystem stability, but may also increase richness, which may offset the decrease in stability.
Such a paradox complicates predictions about how ecosystems will respond as environmental conditions exceed historical ranges of variability because we do not know the net effect of environmental variability on ecosystem stability when species coexistence is fluctuation-dependent.
The unknown net effect of environment variability may be reflected in the mixed results from empirical studies on the diversity-stability relationship.
Observational tests of the diversity-stability relationship, which require sampling across natural diversity gradients, have yielded positive [@Hautier2014], neutral [@Valone2003; @Cusson2015], and negative [@Sasaki2011] relationships.
In a meta-analysis of diversity-stability relationships, @Jiang2009 found no significant evidence for an effect of species richness on ecosystem stability from observational studies in terrestrial ecosystems.
Thus, there appears to be a gap between the consistency of theoretical studies and the equivocation of empirical studies.

We argue this gap exists because the two bodies of theory that have developed to explain species coexistence on the one hand, and diversity-stability relationships on the other, have diverged.
One reason these two disciplines have diverged is because they have focused on slightly different questions.
Biodiversity-ecosystem stability studies typically ask how ecosystem variability responds to different levels of species richness at a given level of environmental variability [reviewed in @Kinzig2001; @Loreau2010], whereas coexistence studies ask how the long term stability of species coexistence responds to different levels of environmental variability [@Chesson1981a].

To reconcile these two bodies of theory, we require a synthetic theory that fully accounts for the linkages among environmental variability, species coexistence, and ecosystem stability.
Here, we extend theory on the relationship between species richness and ecosystem stability to cases in which species coexistence explicitly depends on environmental fluctuations and species-specific responses to environmental conditions.
We focus on the storage effect and relative nonlinearity using a general consumer-resource model.
First, we use model simulations to investigate the diversity-stability relationship across a gradient of environmental variability.
Counter to common expectations, we find that a negative diversity-stability relationship should be expected when sampling occurs over natural diversity gradients and species coexistence is fluctuation-dependent.
Importantly, and in line with previous theory [@Ives2002b; @Loreau2010; @DeMazancourt2013], at a given level of environmental variability, increasing species richness stabilizes ecosystem function, even when coexistence is fluctuation-dependent.
Second, we quantify the net effect of increasing environmental variability on ecosystem stability by isolating the gain in stability due to increased richness and the loss in stability due to increased amplitude of species fluctuations.
A RESULT HERE...

















<!--

Environmental variability is a ubiquitous feature of ecosystems.
On the one hand, environmental fluctuations are disruptive, creating year-to-year variability that decreases the stability of ecosystem functions like annual productivity [@Isbell2015].
On the other hand, environmental fluctuations are stabilizing, providing opportunities for species to coexist [@Chesson2000].
While seemingly unrelated, the countervailing effects of environmental variability become inexorably linked when we consider the relationship between biodiversity and ecosystem stability.
The emerging consensus is that species rich ecosystems are more stable than species poor ecosystems, implying a positive relationship between biodiversity and stability [@Loreau2013].
For the benefits of biodiversity to be realized in the long term, species coexistence, which maintains biodiversity, must be stable [@Turnbull2013].
Yet, contemporary coexistence theory is largely absent from theoretical studies aimed toward understanding the diversity-stability relationship [reviewed in @Loreau2010].

A compelling reason to revisit how species coexist in the context of the diversity-stability relationship is their shared dependence on species-specific responses to environmental conditions, and environmental variability more generally.
Modern coexistence theory can be divided into two broad classes: fluctuation-dependent mechanisms and fluctuation-independent mechanisms [@Chesson2000].
Classic work on resource partitioning [@Tilman1982] describes fluctuation-independent species coexistence, where stable coexistence depends on limiting resource requirements, not fluctuations in population abundances or environmental conditions.
In contrast, fluctuation-dependent coexistence mechanisms require the environment to fluctuate over time for species to coexist.
Indeed, the two most well-known fluctuation-dependent coexistence mechanisms, the storage effect and relative nonlinearity, depend on species-specific responses to environmental conditions, among other things, for species to stably coexist (Box 1).
Thus, two forces can strengthen species coexistence: 1) the uniqueness of their environmental responses and 2) the variability of environmental conditions.
In other words, there is reason to expect environmental variability to promote species richness when coexistence is maintained by a fluctuation-dependent mechanism [@Adler2008].
Why, then, does nearly all theoretical work on the diversity-stability relationship predict a positive relationship?
In short, because such work has ignored fluctuation-dependent coexistence [@Loreau2010].

Theory on the diversity-stability relationship has mainly employed modeling approaches that separate species interactions and species' responses to the environment [@Loreau2010; @Loreau2013].
For example, population dynamical approaches that follow Lotka-Volterra dynamics typically include determinstic species interactions, which in turn determine species coexistence, and an additive, stochastic environmental component [e.g., @Ives1999; @Lehman2000; @Loreau2013].
In such models, species coexistence is pre-determined by the pairwise interaction coeffecients and environmental variability does not impact whether species coexist or not.
Therefore, so long as species' environmental responses are not perfectly correlated, increasing the number of species at a given level of environmental variability generally increases ecosystem stability [@Ives2002b; @Loreau2013]
Because there is no interaction between species coexistence and environmental variability, only the correlation of species' environmental responses determines ecosystem stability.
Despite the lack of fluctuation-dependent coexistence in theor on the diversity-stability relationship, several large experiments have confirmed theoretical predictions [@Tilman2006; @Hector2010].
But, the balance of evidence from all empirical tests is less consistent [@Jiang2009].

Empirical tests of the theoretical prediction that species richness increases ecosystem stability have relied on both experimental and observational approaches.
Experimental tests involve manipulating the number of species present in a plot by randomly drawing a specific number of species from a pre-defined species pool [@Hector1999; @Tilman2001].
Results from such experimental tests, which have focused on plant species richness and the temporal stability of aboveground biomass production, have been surprisingly consistent: temporal stability is greater in communities with more species [@Tilman2006; @Hector2010].

Thus, there appears to be a gap between the consistency of theoretical studies and the equivocation of empirical studies.

We argue this gap exists because the two bodies of theory that have developed to explain species coexistence on the one hand, and diversity-stability relationships on the other, have diverged.
Thus, we require a synthetic theory that fully accounts for the linkages among environmental variability, species coexistence, and ecosystem stability.
Here, we extend theory on the relationship between species richness and ecosystem stability to cases in which species coexistence explicitly depends on environmental fluctuations and species-specific responses to environmental conditions.
We focus on the storage effect and relative nonlinearity using a general consumer-resource model.
Counter to common expectations, we find that negative diversity-stability relationships should be expected when sampling occurs over natural diversity gradients and species coexistence is fluctuation-dependent.
Importantly, and in line with previous theory [@Ives2002b; @Loreau2010; @DeMazancourt2013], at a given level of environmental variability, increasing species richness stabilizes ecosystem function, even when coexistence is fluctuation-dependent.
By revisiting species coexistence, our results help to reconcile why observed diversity-stability relationships are both positive and negative.
-->

MATERIALS AND METHODS
---------------------
###  Consumer-resource model
To discover how fluctuation-dependent coexistence mechanisms affect the diversity-stability relationship, we developed a semi-discrete consumer-resource model that allows many species to coexist on one resource by either the storage effect or relative nonlinearity. 
In our model, the consumer can be in one of two-states: a dormant state $D$ and a live state $N$.
The dormant state could represent, for example, the seedbank of an annual plant.
Transitions between $N$ and $D$ occur at discrete intervals $\tau$ with continuous-time consumer-resource dynamics between discrete transitions. 
Thus, our model is formulated as "pulsed differential equations" [@Pachepsky2008; @Mailleret2009; @Mordecai2016]. 
For clarity we refer to $\tau$ as years and the growing time between years as seasons with daily ($t$) time steps. 

During a growing season, consumer-resource dynamics are modeled as two differential equations:

\begin{align}
\frac{\text{d}N_{i}}{\text{d}t} &= N_{i}\epsilon_if_{i}(R), \quad t \ne \tau_k\\
\frac{\text{d}R}{\text{d}t} &= - \sum\limits_{i=1,2}f_{i}(R)N_{i}, \quad t \ne \tau_k
\end{align}

\noindent where the discrete transitions between $N$ and $D$ occur between seasons at times $\tau_k$, $k = 1,2,3, \dots, K$. The subscript $i$ denotes species, $N$ is the living biomass state, and $\epsilon_i$ is each species' resource-to-biomass conversion efficiency. The growth rate of living biomass is a resource-dependent Hill function, $f_{i}(R) = r_{i}R^{a_{i}} / (b_{i}^{a_{i}}+R^{a_{i}})$, where *r* is a species' intrinsic growth rate and *a* and *b* define the curvature of the function. Resource depletion is equal to the sum of each species' consumption. 

Along with resource uptake, consumer population growth depends on the production of dormant biomass ($D$), the activation of dormant biomass to live biomass ($D \rightarrow N$), and the survival of living biomass from one year to the next. The biomass of each species' states at the start of a growing season are equal to

\begin{align}
  D_{i}(\tau_k^+) &= (1-\gamma_{i,\tau_k})[\alpha_i N_{i}(\tau_k) + D_{i}(\tau_k)](1-\eta_i) \\
  N_{i}(\tau_k^+) &= (1-\alpha_i)N_{i}(\tau_k) + \gamma_{i,t}[\alpha_i N_{i}(\tau_k) + D_{i}(\tau_k)] (1-\eta_i),
\end{align}

\noindent where $D(\tau_k)$, $N(\tau_k)$, and $R(\tau_k)$ are the abundances of each state at the end of growing season *k* and $\tau_k^+$ denotes the beginning of growing season $k=1$. 
The activation of dormant biomass to live biomass is controlled by $\gamma$, which is year (*k*) and species (*i*) specific.
Dormant biomass is equal to a constant fraction ($\alpha$) of live biomass at the end of the previous season ($N_{i}(\tau_k)$), plus survival ($1-\eta_i$) of dormant biomass ($D_{i}(\tau_k)$) at the end of the previous year and dormant biomass remaining after live biomass activation ($D_{i}(\tau_k)(1-\gamma_{i,\tau_k})$).
Live biomass is equal to newly activated dormant biomass ($\gamma_{i,t}[D_{i}(\tau_k)$), minus some fraction of live biomass that is converted to dormant biomass ($(1-\alpha_i)N_{i}(\tau_k)$)
We assume the resource pool is not replenished within a growing season.
Resource replenishment occurs between growing seasons, and the resource pool (*R*) at the start of the growing season *k*+1 is $R(\tau_k^+) = R^+$, where $R^+$ is a random resource pulse drawn from a log-normal distribution with mean $\mu(R^+)$ and standard deviation $\sigma(R^+)$. 
Model parameters and notation are described in table 1.

\begin{centering}
\begin{table}
\footnotesize
\caption{Default values of model parameters and their descriptions. Parameters that vary depending on the mode and strength of species coexistence or depending on species copmetive hierarchies are labeled as "variable" in parantheses. The dormant-to-live biomass transition fraction ($\gamma$) is a function of other parameters, so has no default value.}
\begin{tabular}{l l l}
\hline
Parameter & Description & Value \\
\hline
$r$ & maximum per capita growth rate & 1 (variable) \\
$a$ & Hill function rate parameter & 2 (variable) \\
$b$ & Hill function curvature parameter & 2.5 (variable) \\
$\epsilon$ & resource-to-biomass conversion efficiency & 0.5 \\
$\alpha$ & allocation fraction of live biomass to dormant biomass & 0.5 (variable) \\
$\gamma$ & dormant-to-live biomass transition fraction & -- \\
$\rho$ & correlation of species' response to the environment & 0 (variable) \\
$\sigma_E$ & variance of the environmental cue & 2 (variable) \\
$\eta$ & dormant biomass mortality rate & 0.1 \\
$\mu(R^+)$ & mean annual resource pulse & 20 (non-log scale) \\
$\sigma(R^+)$ & standard deviation of annual resource pulse & 0 (variable) \\
\hline
\end{tabular}
\end{table}
\end{centering}

#### Implementing the Storage Effect
To make this a storage effect model, we need to satisfy three conditions: (1) the organisms must have a mechanism for persistence under unfavorable conditions, (2) species must respond differently to environmental conditions, and (3) the effects of competition on a species must be more strongly negative in good years relative to unfavorable years. 
Our model meets condition 1 because we include a dormant stage with very low death rates. 
We satisfy condition 2 with our model whenever $\gamma$ is not perfectly correlated between species. 
Lastly, our model meets condition 3 because condition 2 partitions intraspecific and interspecific competition into different years. 
Thus, during a high $\gamma$ year for one species, resource uptake is also inherently high for that species, which increases intraspecific competition relative to interspecific competition. 
So, given adequate variability in $\gamma$, the inferior competitor can persist. 
We created competitive hierarchies in the storage effect version of the model by altering species' biomass conversion efficiencies ($\epsilon$)

We generated sequences of (un)correlated dormant-to-live state transition rates ($\gamma$) for each species by drawing from multivariate normal distributions with mean 0 and a variance-covariance matrix ($\Sigma(\gamma)$) of

\begin{align}
\Sigma(\gamma) = 
\begin{bmatrix}
\sigma^2_{E} & \rho\sigma^2_{E} \\
\rho\sigma^2_{E} & \sigma^2_{E}
\end{bmatrix}
\end{align}

\noindent where $\sigma^2_{E}$ is the variance of the environmental cue and $\rho$ is the correlation between between the two species' transition rates. $\rho$ must be less than 1 for stable coexistence.
The inferior competitor has the strongest potential to persist when $\rho=-1$ (perfectly uncorrelated transition rates). 

#### Implementing Relative Nonlinearity
When considering consumer-resource dynamics, species coexistence by relative nonlinearity requires that each species has different nonlinear responses to resource availability, and resource availability must fluctuate through time.
In a constant resource environment, the species with the lowest $R*$ will always exclude the other species. 
To create competitive hierarchies among species we altered species resource uptake curves (Fig. SX).
We still allow the germination rate ($\gamma$) to vary, but both species are perfectly correlated -- that is, $\rho=1$ (Fig. 1). 


```{r model_types, cache=FALSE, warning=FALSE, message=FALSE, eval=TRUE, fig.height=3, fig.width=5, fig.cap="Resource uptake functions and example time series of (un)correlated germination fractions for the storage effect (*a,b*) and relative nonlinearity (*c,d*) formulations of the consumer-resource model. The resource uptake functions for both species are equivalent for the storage effect, but their germination fractions are uncorrelated in time. The opposite is true for relative nonlinearity: the two species have unique resource uptake functions, but their germination fractions are perfectly correlated in time."}
library(ggplot2)
library(ggthemes)
library(mvtnorm)
library(gridExtra)
# mycols <- c("#9D6188","#97A861")
# mycols <- c("black", "grey")
mycols <- c("grey35", "steelblue")

mytheme <- theme(axis.text=element_text(size=6),
                 axis.title=element_text(size=8),
                 legend.text=element_text(size=6),
                 legend.key.size=unit(0.3, "cm"))

 ##  Resource uptake function (Hill function)
  uptake_R <- function(r, R, alpha, beta){
    return((r*R^alpha) / (beta^alpha + R^alpha))
  }
  # Get "germination" fractions for each year
  getG <- function(sigE, rho, nTime){
    varcov <- matrix(c(sigE, rho*sigE, rho*sigE, sigE), 2, 2)
    e <- rmvnorm(n = nTime, mean = c(0,0), sigma = varcov)
    g <- exp(e) / (1+exp(e))
    return(g)
  }

## STORAGE EFFECT PLOTS
parms <- list(
  r = c(5,5),         # max growth rate for each species
  alpha = c(5,5),     # rate parameter for Hill function 
  beta = c(20,20),    # shape parameter for Hill function
  mN = c(0.5,0.5),    # live biomass loss (mortality) rates 
  mD = c(0.01, 0.01), # dormant biomass loss (mortality) rates
  a = c(0.5,0.5)      # allocation fraction of live biomass to seed bank
)
R <- seq(0,100,1)
out_r <- matrix(ncol=2, nrow=length(R))
alpha <- parms$alpha
beta <- parms$beta
for(i in 1:nrow(out_r)){
  out_r[i,1] <- uptake_R(parms$r[1], R[i], alpha[1], beta[1])
  out_r[i,2] <- uptake_R(parms$r[2], R[i], alpha[2], beta[2])
}
strg_uptake <- data.frame(species=rep(c(1:2), each=nrow(out_r)),
                          resource=rep(R, times=2),
                          uptake=c(out_r[,1], out_r[,2]))
strg_uptake_plot <- ggplot()+
  geom_line(data=strg_uptake, aes(x=resource, y=uptake, color=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=mycols, name="", labels=c("Species A", "Species B"))+
  guides(size=FALSE, linetype=FALSE)+
  xlab("Resource")+
  ylab("Resource Uptake Rate")+
  theme(legend.position=c(0.7,0.35))+
  geom_text(aes(x=1,y=5, label="a", size=8))+
  mytheme

sigE <- 2   # environmental cue variability
rho <- 0    # environmental cue correlation between species
gVec <- getG(sigE = sigE, rho = rho, nTime = 20)
germ_rate <- data.frame(species=rep(c(1:2),each=20),
                        timestep=rep(c(1:20), times=2),
                        germrate=c(gVec[,1], gVec[,2]))
strg_germ_plot <- ggplot()+
  geom_line(data=germ_rate,aes(x=timestep, y=germrate, color=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=mycols, name="Species")+
  guides(size=FALSE, linetype=FALSE, color=FALSE)+
  xlab("Simulation Year")+
  ylab("Germination Fraction")+
  geom_text(aes(x=1,y=1,label="b", size=8))+
  mytheme


## RELATIVE NONLINEARITY PLOTS
parms <- list(
  r = c(5,1),          # max growth rate for each species
  alpha = c(5,2),      # rate parameter for Hill function 
  beta = c(20,2.5),    # shape parameter for Hill function
  mN = c(0.5,0.5),     # live biomass loss (mortality) rates 
  mD = c(0.01, 0.01),  # dormant biomass loss (mortality) rates
  a = c(0.5,0.5)       # allocation fraction of live biomass to seed bank
)
R <- seq(0,100,1)
out_r <- matrix(ncol=2, nrow=length(R))
alpha <- parms$alpha
beta <- parms$beta
for(i in 1:nrow(out_r)){
  out_r[i,1] <- uptake_R(parms$r[1], R[i], alpha[1], beta[1])
  out_r[i,2] <- uptake_R(parms$r[2], R[i], alpha[2], beta[2])
}
reln_uptake <- data.frame(species=rep(c(1:2), each=nrow(out_r)),
                          resource=rep(R, times=2),
                          uptake=c(out_r[,1], out_r[,2]))
reln_uptake_plot <- ggplot()+
  geom_line(data=reln_uptake, aes(x=resource, y=uptake, color=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=mycols, name="Species")+
  guides(size=FALSE, linetype=FALSE, color=FALSE)+
  xlab("Resource")+
  ylab("Resource Uptake Rate")+
  geom_text(aes(x=1,y=5,label="c", size=8))+
  mytheme

sigE <- 2   # environmental cue variability
rho <- 1    # environmental cue correlation between species
gVec <- getG(sigE = sigE, rho = rho, nTime = 20)
germ_rate <- data.frame(species=rep(c(1:2),each=20),
                        timestep=rep(c(1:20), times=2),
                        germrate=c(gVec[,1], gVec[,2]))
reln_germ_plot <- ggplot()+
  geom_line(data=germ_rate,aes(x=timestep, y=germrate, color=as.factor(species), linetype=as.factor(species)))+
  theme_few()+
  scale_color_manual(values=mycols, name="Species")+
  guides(size=FALSE, linetype=FALSE, color=FALSE)+
  xlab("Simulation Year")+
  ylab("Germination Fraction")+
  geom_text(aes(x=1,y=1,label="d", size=8))+
  mytheme

g_strg <- grid.arrange(strg_uptake_plot, strg_germ_plot, 
                       reln_uptake_plot, reln_germ_plot,
                       ncol=2, nrow=2)
```

### Model simulations
We simulated the model with four species under two scenarios for each coexistence mechanism.
First, we allowed the variance of the environment to determine how many species can coexist, akin to a community assembly experiment with a species pool of four species.
This required simulating communities with all species initially present across a gradient of annual resource variability (for relative nonlinearity) or environmental cue variability (for the storage effect).
Second, we chose parameter values that allowed coexistence of all four species and performed species removals.
We ran simulations for 10,000 seasons with 20 day growing seasons. 
We averaged biomass over the growing season.
After discarding an initial 1,000 seasons to reduce transient effects on our results, we calculated the coffecient of variation of summed species biomass through time.
For simulations where environmental variability determined species coexistence, we calculated species richness as the number of species whose average biomass was greater than 1 over the course of the simulation.
Within-season dynamics were solved given initial conditions using the package ``deSolve`` [@Soetaert2010] in ``R`` [@Team2013].
All model code has been deposited on Dryad (*link*) and is available on GitHub at http://github.com/atredennick/Coexistence-Stability.

RESULTS
-------

\begin{figure}[!ht]
  \centering
      \includegraphics[height=5in]{./components/main_figure.png}
  \caption{Variability of total community as function of species richness when coexistence is maintained by the storage effect (a,c) or relative nonlinearity (b,d). Top panels show results from simulations where environmental or resource variance determine the number species that coexist in a community. Bottom panels show results from simulations where environmental or resource variance is fixed at a level that allows coexistence of all four species, but speces are removed to manipulate diversity. In the most general sense, the top panels represent regional diversity-stability relationships across natural diversity gradients, whereas the bottom panels represent local diversity-stability relationships.}
\end{figure}

DISCUSSION
----------
The direction of the diversity-variability relationship can be positive and negative when species coexistence is maintained by fluctuation-dependent mechanisms (Fig. 2).
Ecosystem variability is positively correlated with species richness when species richness is measured across a gradient of envrionmental variability, which maintains diversity and promotes ecosystem variability (Fig. 2a,b).
If environmental conditions are sufficient to maintain coexistence, removing species increases ecosystem variability (Fig. 2c,d).
Thus, our results both confirm and contrast with theoretical and experimental findings that diversity begets stability.

When we held environmental variability constant and removed species, we produced the typical negative diversity-variability relationship (Fig. 2c,d), consistent with theoretical expecations from models with species coexistence maintained by fluctuation-dependent mechanisms.
Likewise, our results from the species removal simulations are consistent with results from biodiversity-ecosystem functioning experiments showing a negative relationship between species richness and ecosystem variability.
This is encouraging because species almost certainly coexist by some combination of fluctuation-independent (e.g., resource partitioning) and fluctuation-dependent mechanisms.
By extending theory to communities where species richness is explicitly maintained by temporal variability, we have gained confidence that experimental findings are generalizable to many communities.
In other words, in local settings where environmental variability is relatively homogenous, reductions in the number of species will reduce the stability of ecosystem functioning, regardless of how coexistence is maintained.

When we allowed a gradient of environmental variability to determine species coexistence, we discoverd a positive relationship between species richness and ecosystem variability (Fig. 2a,b).
While surprising when viewed through the lens of previous theory and experimental findings, such a relationship is a direct consequence of how diversity can be maintained in fluctuating environments.
The storage effect and relative nonlinearity both require envrionmental fluctuations to allow niche differentiation between species pairs [@Chesson2000].
Therefore, species coexistence gains strength, for both mechanisms, as the envrionment becomes more variable (Fig. SX).

Our results may explain why deviations from the negative diversity-variability relationship often come from observational studies.
Observational studies must rely on natural diversity gradients, and if species richness depends environmental variability, it is entirely possible to observed positive diversity-variability relationships.
For example, Sasaki and Lauenroth (2011) found a negative relationship between species richness and the temporal stability of plant abundance (a positive diversity-variability relationship) in a semi-arid grassland.
Their data came from a six sites that were 6 km apart.
Thus, it is possible that each site experienced slightly different levels of environmental variability that influenced species coexistence.
Indeed, fluctuation-dependent coexistence mechanisms are particularly common in arid and semi-arid environments (CITATIONS).




<!---
\begin{figure}[!ht]
  \centering
      \includegraphics{./components/fig2_formatted.png}
  \caption{Variability of community biomass and invasion growth rates of the inferior competitor under different parameter combinations. Points are mean values from 10,000 growing seasons and lines are linear fits to show trends. In \textbf{Storage Effect} plots, resource supply is held constant between growing seasons, whereas resource supply varies each year in \textbf{Relative Nonlinearity} simulations.}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/profile_plots_formatted.png}
  \caption{Variability of total community biomass and invasion growth rates of the inferior competitor when the storage effect is strong ($\rho=-0.5$) and weak ($\rho=0.5$), with (filled circles) and without (open circles) relative nonlinearity contributing to coexistence. Simulations without relative nonlinearity were run with species having (\emph{a}) low, (\emph{b}) moderate, and (\emph{c}) high maximum growth rates. Small plots above the main panels shows species resource uptake curves associated with each simulation.}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics[width=3in]{./components/persp_plots_formatted.png}
  \caption{Variability of total community biomass (\emph{a}) and species richness (\emph{b}) as a function of the variance of the environmental cue ($\sigma^2_E$), and the correlation of species responses to the environment ($\rho$). }
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/diversity_stability_relationship.png}
  \caption{Variability of total community biomass as a function of the the number of coexisting species at different levels of correlations of species' responses to environmental conditions ($\rho$).}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/storage_effect_growthrate_cv.png}
  \caption{Relationship between the strength of coexistence (invasion growth rate of inferior competitor) and ecosystem variability. Panels show different levels of environmental cue variability (denoted by number at top of each panel). Color bar shows the correlation between species' germination rates.}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/storage_effect_synchstability.png}
  \caption{Results from storage effect simulations showing the relationships between the correlation of species' responses to the environmental cue for germination and simulated species asynchrony (\textit{a}), coefficient of variation of total community biomass (\textit{b}), mean total community biomass (\textit{c}), and standard deviation of total community biomass (\textit{d}). Color ramps indicate the value of resource variability ($\sigma_R$) for a given simulation.}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/relative_nonlinearity_synchstability.png}
  \caption{Results from relative nonlinearity simulations showing the relationships between tresource variability ($\sigma_R$) and simulated species asynchrony (\textit{a}), coefficient of variation of total community biomass (\textit{b}), mean total community biomass (\textit{c}), and standard deviation of total community biomass (\textit{d}). The correlation of species' responses to the environmental cue for germination was equal to one for all relative nonlinearity simulations ($\rho=1$).}
\end{figure}


\begin{figure}[!ht]
  \centering
      \includegraphics[width=3in]{./components/strength_v_cv.png}
  \caption{Relationship between the strength of coexistence (invasion growth rate of inferior competitor) and ecosystem variability.}
\end{figure}

\begin{figure}[!ht]
  \centering
      \includegraphics{./components/compare_plots.png}
  \caption{Relationship between resource variability ($\sigma_R$) and the coefficient of variation of total community biomass for both coexistence mechanisms. Each panel shows results from different levels of environmental cue correlations ($\rho$) for the storage effect; $\rho=1$ across all panels for relative nonlinearity results. On average, the storage effect leads to less variable biomass production through time.}
\end{figure}

-->

\pagebreak{}

ACKNOWLEDGMENTS
---------------
The National Science Foundation provided funding for this work through a Postdoctoral Research Fellowship in Biology to ATT (DBI-######) and a CAREER award to PBA (DEB-#######).

\setlength{\parindent}{0ex}

REFERENCES
----------
